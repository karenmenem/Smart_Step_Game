/*
 * Optional Arduino Integration for SmartStep
 * 
 * This module integrates Arduino quiz buzzer with the backend server.
 * It's completely optional - the server works fine without it.
 * 
 * To enable:
 * 1. Set ARDUINO_ENABLED=true in your .env file
 * 2. Set ARDUINO_PORT to your Arduino's serial port (e.g., /dev/cu.usbmodem11301)
 * 3. Start the server - Arduino will connect automatically
 * 
 * To disable:
 * 1. Set ARDUINO_ENABLED=false in your .env file
 * 2. Or just remove/comment out those lines
 */

const { SerialPort } = require('serialport');
const { ReadlineParser } = require('@serialport/parser-readline');

// Safe robot import - won't crash if it fails
let robot = null;
try {
  robot = require('robotjs');
} catch (error) {
  console.warn('âš ï¸  RobotJS not available - Arduino keypresses disabled');
}

class ArduinoManager {
  constructor() {
    this.port = null;
    this.parser = null;
    this.isConnected = false;
    this.isEnabled = process.env.ARDUINO_ENABLED === 'true';
    this.arduinoPort = process.env.ARDUINO_PORT || '/dev/cu.usbmodem11301';
    this.baudRate = 9600;
    this.robotAvailable = robot !== null;
  }

  /**
   * Initialize Arduino connection
   * This is called when the server starts
   */
  async initialize() {
    // Skip if Arduino is not enabled
    if (!this.isEnabled) {
      console.log('â„¹ï¸  Arduino integration disabled (ARDUINO_ENABLED=false)');
      return;
    }

    console.log('ðŸŽ® Initializing Arduino integration...');
    console.log(`ðŸ“ Attempting to connect to: ${this.arduinoPort}`);

    try {
      // Create serial port connection
      this.port = new SerialPort({
        path: this.arduinoPort,
        baudRate: this.baudRate,
      });

      // Create parser for reading lines
      this.parser = this.port.pipe(new ReadlineParser({ delimiter: '\n' }));

      // Set up event listeners
      this.setupListeners();

    } catch (error) {
      console.error('âŒ Failed to initialize Arduino:', error.message);
      console.log('ðŸ’¡ Troubleshooting:');
      console.log('   1. Check ARDUINO_PORT in .env matches your Arduino (Tools > Port in Arduino IDE)');
      console.log('   2. Close Serial Monitor in Arduino IDE');
      console.log('   3. Make sure Arduino is plugged in');
      console.log('   4. Set ARDUINO_ENABLED=false in .env to disable Arduino');
      console.log('âš ï¸  Server will continue without Arduino');
      this.isEnabled = false;
    }
  }

  /**
   * Set up event listeners for Arduino communication
   */
  setupListeners() {
    // Handle successful connection
    this.port.on('open', () => {
      this.isConnected = true;
      console.log('âœ… Arduino connected successfully!');
      console.log('ðŸŽ¯ Physical buttons will now simulate keyboard presses');
      console.log('ðŸ“ Make sure quiz window is in focus when using buttons');
    });

    // Handle incoming data from Arduino
    this.parser.on('data', (data) => {
      const message = data.trim();
      
      // Log all Arduino messages (for debugging)
      if (message && !message.startsWith('KEY:')) {
        console.log(`ðŸ“¨ Arduino: ${message}`);`);
          
          // Only try to simulate keypress if robot is available
          if (this.robotAvailable && robot) {
            try {
              robot.keyTap(key);
              console.log(`âœ… Key ${key.toUpperCase()} sent`);
            } catch (error) {
              console.error(`âŒ Keypress failed:`, error.message);
              // Disable robot if it keeps failing
              this.robotAvailable = false;
            }
          } else {
            console.log(`âš ï¸  Ro - WILL NOT CRASH SERVER)
    this.port.on('error', (err) => {
      console.error('âš ï¸  Arduino error:', err.message);
      this.isConnected = false;
      
      // Don't let Arduino errors crash the server
      try {
        // Provide helpful troubleshooting info
        if (err.message.includes('cannot open') || err.message.includes('No such file')) {
          console.log('ðŸ’¡ Arduino port changed or disconnected');
        } else if (err.message.includes('Permission denied')) {
          console.log('ðŸ’¡ Close Serial Monitor in Arduino IDE');
        }
      } catch (e) {
        // Ignore any errors in error handling
      }
      
      console.log('âš ï¸  Server continues running normally
      
      // Provide helpful troubleshooting info
      if (err.message.includes('cannot open') || err.message.includes('No such file')) {
        console.log('ðŸ’¡ The Arduino port may have changed. Check:');
        console.log('   - Arduino IDE: Tools > Port');
        console.log('   - Update ARDUINO_PORT in .env file');
      } else if (err.message.includes('Permission denied')) {
        console.log('ðŸ’¡ Permission issue. Try:');
        console.log('   - Close Serial Monitor in Arduino IDE');
        console.log('   - Unplug and replug Arduino');
        console.log('   - Restart the server');
      }
      
      console.log('âš ï¸  Arduino disabled - server continues running');
    });

    // Handle disconnection
    this.port.on('close', () => {
      if (this.isConnected) {
        console.log('ðŸ”Œ Arduino disconnected');
        this.isConnected = false;
      }
    });
    
    } catch (error) {
      // Catch any errors during listener setup
      console.error('âš ï¸  Error setting up Arduino listeners:', error.message);
      console.log('âš ï¸  Server continues running normally');
      this.isEnabled = false;
    }
  }

  /**
   * Send feedback to Arduino (correct/wrong answer)
   * This makes the LEDs light up based on answer correctness
   */
  sendFeedback(isCorrect) {
    if (!this.isConnected || !this.port || !this.port.isOpen) {
      return; // Silently fail if Arduino not connected
    }

    try {
      const feedback = isCorrect ? 'CORRECT\n' : 'WRONG\n';
      this.port.write(feedback);
      console.log(`ðŸ“¤ Sent to Arduino: ${isCorrect ? 'CORRECT' : 'WRONG'}`);
    } catch (error) {
      console.error('Failed to send feedback to Arduino:', error.message);
    }
  }

  /**
   * Gracefully close Arduino connection
   * This is called when the server shuts down
   */
  async close() {
    if (!this.port || !this.isConnected) {
      return;
    }

    console.log('ðŸ‘‹ Closing Arduino connection...');
    
    return new Promise((resolve) => {
      this.port.close((err) => {
        if (err) {
          console.error('Error closing Arduino port:', err.message);
        } else {
          console.log('âœ… Arduino connection closed cleanly');
        }
        this.isConnected = false;
        resolve();
      });
    });
  }

  /**
   * Check if Arduino is currently connected
   */
  isArduinoConnected() {
    return this.isConnected;
  }

  /**
   * Get Arduino status information
   */
  getStatus() {
    return {
      enabled: this.isEnabled,
      connected: this.isConnected,
      port: this.arduinoPort,
    };
  }
}

// Create singleton instance
const arduinoManager = new ArduinoManager();

module.exports = arduinoManager;
